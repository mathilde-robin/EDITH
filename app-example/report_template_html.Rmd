---
title: "Rapport d'Analyse de Synergie - Formule de Bliss"
author: "Application Shiny - Analyse de Synergie"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: hide
    df_print: paged
    fig_width: 10
    fig_height: 6
params:
  analysis_type: "simple"
  simple_data: NULL
  matrix_data: NULL
  multiple_data: NULL
  multiple_results: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE,
  fig.align = "center",
  dpi = 300
)

# Charger les packages n√©cessaires
suppressPackageStartupMessages({
  library(ggplot2)
  library(dplyr)
  library(knitr)
  library(kableExtra)
})

# Source des fonctions
source("utils/bliss_functions.R")
```

# Introduction

Ce rapport pr√©sente les r√©sultats d'une analyse de synergie utilisant la **formule de Bliss**. Cette m√©thode permet d'√©valuer si l'effet combin√© de deux drogues est synergique, additif ou antagoniste.

## Principe de la Formule de Bliss

La formule de Bliss calcule l'effet attendu d'une combinaison de drogues selon :

$$E_{attendu} = E_A + E_B - (E_A \times E_B)$$

O√π :
- $E_A$ = Effet de la drogue A
- $E_B$ = Effet de la drogue B
- $E_{attendu}$ = Effet attendu selon le mod√®le de Bliss

## Interpr√©tation des R√©sultats

- **Synergie** : Effet observ√© > Effet attendu (diff√©rence > 0.05)
- **Additivit√©** : Effet observ√© ‚âà Effet attendu (|diff√©rence| ‚â§ 0.05)
- **Antagonisme** : Effet observ√© < Effet attendu (diff√©rence < -0.05)

```{r conditional-content}
# Le contenu suivant est conditionnel selon le type d'analyse
analysis_type <- params$analysis_type
```

`r if(analysis_type == "simple") "# Analyse Simple"`

```{r simple-analysis, eval=analysis_type=="simple"}
if (analysis_type == "simple" && !is.null(params$simple_data)) {
  simple_data <- params$simple_data
  
  cat("## Param√®tres d'Entr√©e\n\n")
  cat("- **Effet Drogue A** :", simple_data$effect_A, "\n")
  cat("- **Effet Drogue B** :", simple_data$effect_B, "\n") 
  cat("- **Effet Observ√©** :", simple_data$observed_effect, "\n\n")
  
  cat("## R√©sultats des Calculs\n\n")
  cat("- **Effet Attendu (Bliss)** :", round(simple_data$expected_effect, 4), "\n")
  cat("- **Diff√©rence** :", round(simple_data$difference, 4), "\n")
  cat("- **Pourcentage de Synergie** :", round(simple_data$synergy_percent, 2), "%\n")
  cat("- **Type d'Interaction** :", simple_data$interaction_type, "\n\n")
}
```

```{r simple-plot, eval=analysis_type=="simple", fig.cap="Comparaison des effets selon la formule de Bliss"}
if (analysis_type == "simple" && !is.null(params$simple_data)) {
  print(plot_bliss_comparison_static(params$simple_data))
}
```

```{r simple-interpretation, eval=analysis_type=="simple"}
if (analysis_type == "simple" && !is.null(params$simple_data)) {
  simple_data <- params$simple_data
  
  cat("## Interpr√©tation\n\n")
  
  if (simple_data$interaction_type == "Synergique") {
    cat("üîº **SYNERGIE D√âTECT√âE** : L'effet combin√© des deux drogues est **sup√©rieur** √† ce qui √©tait attendu selon le mod√®le de Bliss. Cela sugg√®re une interaction positive entre les deux substances.\n\n")
    cat("**Implications** : La combinaison de ces drogues pourrait √™tre plus efficace que l'utilisation de chacune s√©par√©ment.\n\n")
  } else if (simple_data$interaction_type == "Antagoniste") {
    cat("üîΩ **ANTAGONISME D√âTECT√â** : L'effet combin√© des deux drogues est **inf√©rieur** √† ce qui √©tait attendu selon le mod√®le de Bliss. Cela sugg√®re une interaction n√©gative entre les deux substances.\n\n")
    cat("**Implications** : La combinaison de ces drogues pourrait √™tre moins efficace que pr√©vu.\n\n")
  } else {
    cat("‚û°Ô∏è **ADDITIVIT√â** : L'effet combin√© des deux drogues correspond √† ce qui √©tait attendu selon le mod√®le de Bliss. Les effets s'additionnent de mani√®re pr√©visible.\n\n")
    cat("**Implications** : La combinaison se comporte comme attendu, sans interaction particuli√®re.\n\n")
  }
}
```

`r if(analysis_type == "matrix") "# Analyse de Matrice de Doses"`

```{r matrix-analysis, eval=analysis_type=="matrix"}
if (analysis_type == "matrix" && !is.null(params$matrix_data)) {
  matrix_data <- params$matrix_data
  
  cat("## Configuration de la Matrice\n\n")
  cat("- **Nombre de combinaisons** :", nrow(matrix_data), "\n")
  cat("- **Dose maximale A** :", max(matrix_data$dose_A), "\n")
  cat("- **Dose maximale B** :", max(matrix_data$dose_B), "\n\n")
  
  # Statistiques
  stats <- matrix_data %>%
    summarise(
      synergiques = sum(interaction_type == "Synergique"),
      additifs = sum(interaction_type == "Additif"),
      antagonistes = sum(interaction_type == "Antagoniste"),
      total = n(),
      pct_syn = round(synergiques/total*100, 1),
      pct_add = round(additifs/total*100, 1),
      pct_ant = round(antagonistes/total*100, 1)
    )
  
  cat("## Statistiques Globales\n\n")
  cat("- **Combinaisons Synergiques** :", stats$synergiques, "/", stats$total, "(", stats$pct_syn, "%)\n")
  cat("- **Combinaisons Additives** :", stats$additifs, "/", stats$total, "(", stats$pct_add, "%)\n")
  cat("- **Combinaisons Antagonistes** :", stats$antagonistes, "/", stats$total, "(", stats$pct_ant, "%)\n\n")
}
```

```{r matrix-plot, eval=analysis_type=="matrix", fig.cap="Heatmap de synergie pour les diff√©rentes combinaisons de doses"}
if (analysis_type == "matrix" && !is.null(params$matrix_data)) {
  print(plot_synergy_heatmap_static(params$matrix_data))
}
```

```{r matrix-table, eval=analysis_type=="matrix"}
if (analysis_type == "matrix" && !is.null(params$matrix_data)) {
  cat("## Donn√©es D√©taill√©es (20 premi√®res combinaisons)\n\n")
  
  table_data <- params$matrix_data %>%
    select(dose_A, dose_B, effect_A, effect_B, expected_effect, observed_effect, 
           difference, interaction_type) %>%
    mutate(across(where(is.numeric), ~round(.x, 4))) %>%
    head(20)
  
  kable(table_data, 
        caption = "D√©tail des combinaisons de doses et leurs effets",
        col.names = c("Dose A", "Dose B", "Effet A", "Effet B", 
                     "Attendu", "Observ√©", "Diff√©rence", "Type")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

`r if(analysis_type == "multiple") "# Analyse de Donn√©es Multiples"`

```{r multiple-analysis, eval=analysis_type=="multiple"}
if (analysis_type == "multiple" && !is.null(params$multiple_results)) {
  multiple_results <- params$multiple_results
  multiple_data <- params$multiple_data
  stats <- multiple_results$statistics
  
  cat("## Donn√©es d'Entr√©e\n\n")
  cat("- **Nombre d'√©chantillons** :", stats$n_samples, "\n")
  cat("- **Source** : Saisie manuelle ou import CSV\n\n")
  
  cat("## Statistiques Descriptives\n\n")
  cat("- **Synergie moyenne** :", round(stats$mean_synergy, 4), "\n")
  cat("- **√âcart-type** :", round(stats$sd_synergy, 4), "\n\n")
  
  cat("## R√©partition des Types d'Interaction\n\n")
  cat("- **Synergiques** :", stats$n_synergistic, "(", stats$percent_synergistic, "%)\n")
  cat("- **Additifs** :", stats$n_additive, "(", stats$percent_additive, "%)\n")
  cat("- **Antagonistes** :", stats$n_antagonistic, "(", stats$percent_antagonistic, "%)\n\n")
}
```

```{r multiple-plots, eval=analysis_type=="multiple", fig.height=10}
if (analysis_type == "multiple" && !is.null(params$multiple_results)) {
  library(gridExtra)
  
  # Distribution des effets
  p1 <- plot_synergy_distribution_static(params$multiple_results$results)
  
  # Graphique en secteurs
  p2 <- plot_interaction_pie(params$multiple_results$statistics)
  
  # Combiner les graphiques
  grid.arrange(p1, p2, ncol = 1, 
               top = "Visualisations de l'analyse multiple")
}
```

```{r multiple-table, eval=analysis_type=="multiple"}
if (analysis_type == "multiple" && !is.null(params$multiple_results)) {
  cat("## R√©sultats D√©taill√©s\n\n")
  
  table_data <- params$multiple_results$results %>%
    select(effet_A, effet_B, effet_observe, expected_effect, difference, 
           synergy_percent, interaction_type) %>%
    mutate(across(where(is.numeric), ~round(.x, 4)))
  
  kable(table_data,
        caption = "R√©sultats d√©taill√©s de l'analyse de synergie",
        col.names = c("Effet A", "Effet B", "Observ√©", "Attendu", 
                     "Diff√©rence", "% Synergie", "Type")) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

# Conclusions et Recommandations

```{r conclusions}
cat("## R√©sum√© de l'Analyse\n\n")

if (analysis_type == "simple") {
  if (!is.null(params$simple_data)) {
    simple_data <- params$simple_data
    cat("Cette analyse simple a r√©v√©l√© une interaction de type **", simple_data$interaction_type, "** entre les deux drogues test√©es.\n\n")
    
    if (simple_data$interaction_type == "Synergique") {
      cat("**Recommandations** :\n")
      cat("- Explorer davantage cette combinaison prometteuse\n")
      cat("- Consid√©rer des tests √† diff√©rentes doses\n")
      cat("- Valider sur un √©chantillon plus large\n\n")
    }
  }
} else if (analysis_type == "matrix") {
  if (!is.null(params$matrix_data)) {
    matrix_data <- params$matrix_data
    synergy_pct <- round(sum(matrix_data$interaction_type == "Synergique") / nrow(matrix_data) * 100, 1)
    
    cat("L'analyse de matrice a r√©v√©l√© que ", synergy_pct, "% des combinaisons de doses test√©es pr√©sentent une synergie.\n\n")
    
    cat("**Recommandations** :\n")
    cat("- Identifier les zones de doses optimales (zone bleue sur la heatmap)\n")
    cat("- √âviter les zones d'antagonisme (zone rouge)\n")
    cat("- Affiner l'analyse autour des doses prometteuses\n\n")
  }
} else if (analysis_type == "multiple") {
  if (!is.null(params$multiple_results)) {
    stats <- params$multiple_results$statistics
    
    cat("L'analyse de ", stats$n_samples, " √©chantillons a r√©v√©l√© :\n")
    cat("- ", stats$percent_synergistic, "% de combinaisons synergiques\n")
    cat("- Une synergie moyenne de ", round(stats$mean_synergy, 3), "\n\n")
    
    if (stats$percent_synergistic > 50) {
      cat("**Observation** : La majorit√© des combinaisons montrent une synergie, sugg√©rant une interaction positive g√©n√©rale.\n\n")
    }
    
    cat("**Recommandations** :\n")
    cat("- Approfondir l'√©tude des √©chantillons les plus synergiques\n")
    cat("- Analyser les facteurs communs aux combinaisons efficaces\n")
    cat("- Consid√©rer une √©tude dose-r√©ponse\n\n")
  }
}

cat("## Notes M√©thodologiques\n\n")
cat("- Cette analyse utilise la formule de Bliss comme r√©f√©rence\n")
cat("- Le seuil de synergie/antagonisme est fix√© √† ¬±0.05\n") 
cat("- Les r√©sultats doivent √™tre valid√©s exp√©rimentalement\n")
cat("- Consid√©rer d'autres mod√®les (Loewe, HSA) pour confirmation\n\n")

cat("---\n\n")
cat("**Rapport g√©n√©r√© le** :", format(Sys.time(), "%d/%m/%Y √† %H:%M"), "\n")
cat("**Application** : Shiny - Analyse de Synergie v2.0\n")
```
